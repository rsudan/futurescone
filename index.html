<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WB Innovation Labs - Deep Foresight Engine</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@500;700&family=Merriweather:ital,wght@0,300;0,400;0,700;1,300&display=swap" rel="stylesheet">
    
    <!-- Document Parsers & PDF Generator -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #334155;
        }
        .display-font {
            font-family: 'Space Grotesk', sans-serif;
        }
        .serif-font {
            font-family: 'Merriweather', serif;
        }
        .animate-fade-in {
            animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
        /* Report specific styles */
        #report-container {
            position: absolute;
            left: -9999px;
            top: 0;
            width: 800px; /* A4 width approx */
        }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">

const { useState, useEffect, useRef } = React;

// --- Icons ---
const Icon = ({ children, size = 20, className = "" }) => (
    <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>
);

const Icons = {
    Upload: (p) => <Icon {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></Icon>,
    Brain: (p) => <Icon {...p}><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></Icon>,
    Settings: (p) => <Icon {...p}><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></Icon>,
    Alert: (p) => <Icon {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></Icon>,
    Search: (p) => <Icon {...p}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></Icon>,
    Zap: (p) => <Icon {...p}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></Icon>,
    Globe: (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></Icon>,
    FileText: (p) => <Icon {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></Icon>,
    Clock: (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></Icon>,
    Key: (p) => <Icon {...p}><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></Icon>,
    Edit: (p) => <Icon {...p}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></Icon>,
    MousePointer: (p) => <Icon {...p}><path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/><path d="M13 13l6 6"/></Icon>,
    Info: (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></Icon>,
    Download: (p) => <Icon {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></Icon>,
    XCircle: (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></Icon>,
    CheckCircle: (p) => <Icon {...p}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></Icon>
};

// --- DEFAULT SYSTEM PROMPT ---
const DEFAULT_SYSTEM_PROMPT = `You are a Strategic Foresight expert at the World Bank Innovation Labs. 
Analyze the following Project Concept Note text with a forecast horizon of {{HORIZON}} years.

Time Horizon: {{HORIZON}} Years from today.

Project Text: "{{TEXT}}"

Output a JSON object with this EXACT structure (ensure strictly valid JSON):
{
    "sector": "Specific Sector Name (e.g. AgriTech)",
    "project_summary": "A concise executive summary of the uploaded document, highlighting key objectives, components, and target beneficiaries (approx 100-150 words).",
    "probable": "A baseline forecast for {{HORIZON}} years out. What is the most likely outcome if current trends continue?",
    "plausible": "A divergent scenario based on current weak signals amplifying. What if a key assumption shifts?",
    "possible": "A transformative scenario driven by radical tech or social shifts by year {{HORIZON}}. Think big.",
    "wildcard": "A low-probability, high-impact 'Black Swan' event specific to this context.",
    "risk": "A critical hidden structural risk relevant to this horizon.",
    "recommendation": "A surprising, concrete action to future-proof the project."
}`;

// --- Logic Layer ---
const generateDeepInsights = async (text, apiKey, timeHorizon, customPromptTemplate) => {
    if (!apiKey) throw new Error("API Key is missing. Please add it in Settings.");

    const prompt = customPromptTemplate
        .replace(/{{HORIZON}}/g, timeHorizon)
        .replace(/{{TEXT}}/g, text.substring(0, 5000));

    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 30000); 

    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }),
            signal: controller.signal
        });
        
        clearTimeout(timeoutId);

        if (!response.ok) {
            const errData = await response.json();
            throw new Error(`AI Service Error: ${errData.error?.message || response.statusText}`);
        }
        
        const data = await response.json();
        
        if (!data.candidates || data.candidates.length === 0) throw new Error("No insights generated. Content might be blocked.");

        const rawText = data.candidates[0].content?.parts?.[0]?.text;
        if (!rawText) throw new Error("Empty response from AI.");

        const jsonText = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
        return JSON.parse(jsonText);
    } catch (e) {
        clearTimeout(timeoutId);
        if (e.name === 'AbortError') {
            throw new Error("Request timed out. The model took too long to respond.");
        }
        console.error("API Call Failed", e);
        throw e;
    }
};

const extractTextFromFile = async (file) => {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onerror = () => reject("File reading failed.");

        if (file.type === "application/pdf") {
            reader.onload = async (e) => {
                try {
                    const typedarray = new Uint8Array(e.target.result);
                    if (typeof pdfjsLib === 'undefined') throw new Error("PDF parser not loaded. Check internet connection.");
                    const pdf = await pdfjsLib.getDocument(typedarray).promise;
                    let fullText = "";
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        fullText += textContent.items.map(item => item.str).join(" ") + "\n";
                    }
                    resolve(fullText);
                } catch (err) { reject("Failed to parse PDF: " + err.message); }
            };
            reader.readAsArrayBuffer(file);
        } else if (file.type === "application/vnd.openxmlformats-officedocument.wordprocessingml.document") {
            reader.onload = async (e) => {
                try {
                    const result = await mammoth.extractRawText({ arrayBuffer: e.target.result });
                    resolve(result.value);
                } catch (err) { reject("Failed to parse DOCX: " + err.message); }
            };
            reader.readAsArrayBuffer(file);
        } else {
            reader.onload = (e) => resolve(e.target.result);
            reader.readAsText(file);
        }
    });
};

// --- Visualization ---
const ConeVisualization = ({ width, height, activeZone, onZoneClick, timeHorizon }) => {
    const originX = 40;
    const originY = height / 2;
    const maxLen = width - 150; 
    const endX = originX + maxLen;

    const layers = [
        { id: 'possible', label: 'Possible', color: '#8b5cf6', topY: originY - 110, bottomY: originY + 110 },
        { id: 'plausible', label: 'Plausible', color: '#10b981', topY: originY - 70, bottomY: originY + 70 },
        { id: 'probable', label: 'Probable', color: '#3b82f6', topY: originY - 35, bottomY: originY + 35 },
    ];

    const createConePath = (topY, bottomY) => {
        const path = `M ${originX} ${originY} L ${endX} ${topY}`;
        const rx = 20; 
        const ry = (bottomY - topY) / 2;
        return `${path} A ${rx} ${ry} 0 0 1 ${endX} ${bottomY} L ${originX} ${originY}`;
    };

    const createCapEllipse = (topY, bottomY) => {
        const ry = (bottomY - topY) / 2;
        const cy = topY + ry;
        return { cy, ry };
    };

    return (
        <svg width="100%" height="100%" viewBox={`0 0 ${width} ${height}`} className="overflow-visible select-none">
            <defs>
                <linearGradient id="grad-probable" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stopColor="#3b82f6" stopOpacity="0.05" />
                    <stop offset="100%" stopColor="#3b82f6" stopOpacity="0.6" />
                </linearGradient>
                <linearGradient id="grad-plausible" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stopColor="#10b981" stopOpacity="0.05" />
                    <stop offset="100%" stopColor="#10b981" stopOpacity="0.4" />
                </linearGradient>
                <linearGradient id="grad-possible" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stopColor="#8b5cf6" stopOpacity="0.05" />
                    <stop offset="100%" stopColor="#8b5cf6" stopOpacity="0.25" />
                </linearGradient>
                <filter id="glow" x="-20%" y="-20%" width="140%" height="140%">
                    <feGaussianBlur stdDeviation="3" result="blur" />
                    <feComposite in="SourceGraphic" in2="blur" operator="over" />
                </filter>
            </defs>

            {/* Time Axis */}
            <line x1={originX} y1={originY} x2={endX + 30} y2={originY} stroke="#cbd5e1" strokeWidth="1" strokeDasharray="4,4" />
            <text x={originX} y={originY + 20} className="text-[10px] font-bold fill-slate-400 font-mono" textAnchor="middle">NOW</text>
            <text x={endX} y={originY + 160} className="text-[10px] font-bold fill-slate-400 font-mono uppercase tracking-widest" textAnchor="middle">
                {timeHorizon}Y Horizon
            </text>

            {/* Cones */}
            {layers.map(layer => {
                const isActive = activeZone === layer.id;
                const opacity = isActive ? 1 : 0.4;
                const cap = createCapEllipse(layer.topY, layer.bottomY);
                
                return (
                    <g 
                        key={layer.id} 
                        onClick={() => onZoneClick(layer.id)} 
                        className="cursor-pointer transition-all duration-500 ease-out group"
                        style={{opacity: opacity}}
                    >
                        <path 
                            d={createConePath(layer.topY, layer.bottomY)} 
                            fill={`url(#grad-${layer.id})`}
                            stroke={layer.color}
                            strokeWidth={isActive ? 1.5 : 0.5}
                        />
                        <ellipse 
                            cx={endX} 
                            cy={originY} 
                            rx={20} 
                            ry={cap.ry}
                            fill={layer.color}
                            fillOpacity={0.15}
                            stroke={layer.color}
                            strokeWidth={isActive ? 2 : 1}
                        />
                        <line 
                            x1={endX + 20} 
                            y1={cap.cy - (cap.ry * 0.5)} 
                            x2={endX + 40} 
                            y2={cap.cy - (cap.ry * 0.5)} 
                            stroke={layer.color} 
                            strokeWidth="1"
                        />
                        <text 
                            x={endX + 45} 
                            y={cap.cy - (cap.ry * 0.5) + 4} 
                            fill={layer.color}
                            className={`text-xs font-bold uppercase tracking-widest transition-all ${isActive ? 'text-sm' : ''}`}
                        >
                            {layer.label}
                        </text>
                    </g>
                );
            })}

            {/* Wildcard */}
            <g onClick={() => onZoneClick('wildcard')} className={`cursor-pointer transition-all duration-300 ${activeZone === 'wildcard' ? 'opacity-100 scale-105 origin-center' : 'opacity-80'}`}>
                <circle cx={endX - 30} cy={originY - 140} r="16" fill="url(#grad-possible)" stroke="#fbbf24" strokeWidth="2" filter="url(#glow)"/>
                <circle cx={endX - 30} cy={originY - 140} r="6" fill="#fbbf24" />
                <text x={endX - 10} y={originY - 136} className="text-[10px] font-bold fill-amber-500 uppercase tracking-wide">Wildcard</text>
            </g>

            {/* Usability Hint */}
            <g className="pointer-events-none opacity-60">
                <text x={originX + 120} y={originY - 80} className="text-[10px] fill-slate-400 font-medium italic">Click zones to view</text>
                <path d={`M ${originX + 115} ${originY - 75} Q ${originX + 100} ${originY - 60} ${originX + 110} ${originY - 40}`} fill="none" stroke="#94a3b8" strokeWidth="1" strokeDasharray="2,2"/>
            </g>
        </svg>
    );
};

// --- Timeline Selector ---
const TimelineSelector = ({ value, onChange }) => {
    const options = [
        { years: 5, label: "Operational", sub: "Tactical" },
        { years: 10, label: "Strategic", sub: "Growth" },
        { years: 20, label: "Transformational", sub: "Disruptive" },
        { years: 30, label: "Visionary", sub: "Systemic" }
    ];

    return (
        <div className="w-full bg-slate-50 p-6 rounded-2xl border border-slate-100 mb-6">
            <div className="flex justify-between items-center mb-4">
                <div className="flex items-center gap-2 text-slate-700">
                    <Icons.Clock size={16} className="text-blue-600" />
                    <span className="text-xs font-bold uppercase tracking-widest">Forecast Horizon</span>
                </div>
            </div>
            
            <div className="grid grid-cols-4 gap-3">
                {options.map((opt) => (
                    <button
                        key={opt.years}
                        onClick={() => onChange(opt.years)}
                        className={`py-3 px-2 rounded-xl border-2 transition-all duration-200 flex flex-col items-center justify-center gap-1
                            ${value === opt.years 
                                ? 'border-blue-500 bg-blue-50 text-blue-700 shadow-sm transform scale-[1.02]' 
                                : 'border-transparent bg-white text-slate-500 hover:border-slate-200 hover:bg-slate-50'}`}
                    >
                        <span className="text-xl font-bold display-font">{opt.years}y</span>
                        <div className="flex flex-col items-center leading-none">
                            <span className="text-[10px] font-bold uppercase tracking-tight">{opt.label}</span>
                            <span className="text-[8px] opacity-60 mt-0.5">{opt.sub}</span>
                        </div>
                    </button>
                ))}
            </div>
        </div>
    );
};

// --- Report Template ---
const ReportTemplate = ({ data, timeHorizon }) => (
    <div id="report-template" className="p-12 bg-white max-w-[800px] text-slate-900 font-sans">
        <div className="border-b-4 border-blue-600 pb-6 mb-8">
            <h1 className="text-3xl font-serif font-bold text-slate-900 mb-2">Deep Foresight Analysis</h1>
            <div className="flex justify-between items-end">
                <div>
                    <p className="text-xs uppercase tracking-widest text-slate-500 mb-1">World Bank Innovation Labs</p>
                    <p className="text-lg font-bold text-blue-600">{data.sector}</p>
                </div>
                <div className="text-right">
                    <p className="text-xs text-slate-400">Generated on</p>
                    <p className="font-medium text-sm">{new Date().toLocaleDateString()}</p>
                </div>
            </div>
        </div>

        {/* Project Executive Summary */}
        <div className="mb-8">
             <h2 className="text-xl font-bold text-slate-900 border-b-2 border-slate-100 pb-2 mb-4">Project Executive Summary</h2>
             <p className="text-sm text-slate-700 leading-relaxed text-justify">{data.project_summary || "No summary available."}</p>
        </div>

        <div className="bg-slate-50 p-6 rounded-lg border border-slate-200 mb-8">
            <h3 className="text-sm font-bold text-slate-900 uppercase tracking-wide mb-3 flex items-center gap-2">
                <span className="w-2 h-2 bg-blue-600 rounded-full"></span> Analysis Context
            </h3>
            <p className="text-sm text-slate-700 leading-relaxed italic">
                Forecast Horizon: {timeHorizon} Years. This report identifies probable, plausible, possible, and wildcard futures for the uploaded project documentation.
            </p>
        </div>
        
        <div className="space-y-6 mb-10">
            <h2 className="text-xl font-bold text-slate-900 border-l-4 border-slate-900 pl-4">Future Scenarios</h2>
            <div className="grid grid-cols-1 gap-6">
                <div className="border border-blue-100 rounded-lg p-5 bg-white">
                    <h4 className="text-blue-700 font-bold uppercase text-xs mb-2">Probable (Baseline)</h4>
                    <p className="text-sm leading-relaxed text-slate-700">{data.probable}</p>
                </div>
                <div className="border border-emerald-100 rounded-lg p-5 bg-white">
                    <h4 className="text-emerald-700 font-bold uppercase text-xs mb-2">Plausible (Alternative)</h4>
                    <p className="text-sm leading-relaxed text-slate-700">{data.plausible}</p>
                </div>
                <div className="border border-purple-100 rounded-lg p-5 bg-white">
                    <h4 className="text-purple-700 font-bold uppercase text-xs mb-2">Possible (Transformational)</h4>
                    <p className="text-sm leading-relaxed text-slate-700">{data.possible}</p>
                </div>
                <div className="border border-amber-100 rounded-lg p-5 bg-white">
                    <h4 className="text-amber-700 font-bold uppercase text-xs mb-2">Wildcard (Disruptive)</h4>
                    <p className="text-sm leading-relaxed text-slate-700">{data.wildcard}</p>
                </div>
            </div>
        </div>
        
        {/* Force New Page for Strategic Implications */}
        <div style={{ pageBreakBefore: 'always' }}>
            <h2 className="text-xl font-bold text-slate-900 border-l-4 border-slate-900 pl-4 mb-6">Strategic Implications</h2>
            <div className="grid grid-cols-2 gap-6">
                <div className="bg-orange-50 p-5 rounded-lg border border-orange-100">
                    <h4 className="text-orange-800 font-bold uppercase text-xs mb-2">Hidden Structural Risk</h4>
                    <p className="text-sm text-slate-800 leading-relaxed">{data.risk}</p>
                </div>
                <div className="bg-blue-50 p-5 rounded-lg border border-blue-100">
                    <h4 className="text-blue-800 font-bold uppercase text-xs mb-2">Strategic Recommendation</h4>
                    <p className="text-sm text-slate-800 leading-relaxed">{data.recommendation}</p>
                </div>
            </div>
        </div>
        
        <div className="mt-12 pt-6 border-t border-slate-200 text-center text-[10px] text-slate-400">
            Powered by WB Innovation Labs Deep Foresight Engine • AI Generated Content
        </div>
    </div>
);

// --- Settings Modal ---
const SettingsModal = ({ isOpen, onClose, apiKey, setApiKey, systemPrompt, setSystemPrompt }) => {
    const [activeTab, setActiveTab] = useState('general');
    const [localKey, setLocalKey] = useState(apiKey);
    const [localPrompt, setLocalPrompt] = useState(systemPrompt);
    const [testStatus, setTestStatus] = useState('idle');
    const [testMsg, setTestMsg] = useState('');
    
    useEffect(() => {
        if(isOpen) {
            setLocalKey(apiKey);
            setLocalPrompt(systemPrompt);
            setTestStatus('idle');
            setTestMsg('');
        }
    }, [isOpen, apiKey, systemPrompt]);

    const handleTestConnection = async () => {
        if(!localKey) {
            setTestStatus('error');
            setTestMsg("Please enter a key first.");
            return;
        }
        setTestStatus('testing');
        setTestMsg('Pinging Gemini API...');
        
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${localKey.trim()}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: "Hello" }] }] })
            });
            
            if(!response.ok) {
                const err = await response.json();
                throw new Error(err.error?.message || "Invalid Key");
            }
            setTestStatus('success');
            setTestMsg("Connection Successful!");
        } catch(e) {
            setTestStatus('error');
            setTestMsg(`Connection Failed: ${e.message}`);
        }
    };

    const handleSave = () => {
        const trimmedKey = localKey.trim();
        setApiKey(trimmedKey);
        localStorage.setItem('gemini_api_key', trimmedKey);
        setSystemPrompt(localPrompt);
        localStorage.setItem('wb_foresight_prompt', localPrompt);
        onClose();
    };

    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-slate-900/60 backdrop-blur-sm animate-fade-in">
            <div className="bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
                <div className="bg-slate-900 px-6 py-4 flex justify-between items-center text-white shrink-0">
                    <h3 className="font-bold flex items-center gap-2"><Icons.Settings size={18}/> App Configuration</h3>
                    <button onClick={onClose} className="hover:text-blue-300 transition-colors">✕</button>
                </div>
                <div className="flex border-b border-slate-200 shrink-0">
                    <button onClick={() => setActiveTab('general')} className={`px-6 py-3 text-sm font-bold border-b-2 transition-colors ${activeTab === 'general' ? 'border-blue-600 text-blue-600 bg-blue-50/50' : 'border-transparent text-slate-500 hover:bg-slate-50'}`}>General & API Key</button>
                    <button onClick={() => setActiveTab('prompt')} className={`px-6 py-3 text-sm font-bold border-b-2 transition-colors ${activeTab === 'prompt' ? 'border-blue-600 text-blue-600 bg-blue-50/50' : 'border-transparent text-slate-500 hover:bg-slate-50'}`}>Prompt Engineering</button>
                </div>
                <div className="p-6 overflow-y-auto custom-scrollbar">
                    {activeTab === 'general' && (
                        <div className="space-y-4">
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Google Gemini API Key</label>
                                <div className="flex gap-2">
                                    <div className="relative flex-1">
                                        <input type="password" value={localKey} onChange={(e) => setLocalKey(e.target.value)} placeholder="AIzaSy..." className="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none font-mono text-sm" />
                                        <div className="absolute left-3 top-3.5 text-slate-400"><Icons.Key size={16}/></div>
                                    </div>
                                    <button 
                                        onClick={handleTestConnection}
                                        disabled={testStatus === 'testing'}
                                        className="px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-xl text-xs font-bold border border-slate-200 whitespace-nowrap"
                                    >
                                        {testStatus === 'testing' ? 'Testing...' : 'Test Connection'}
                                    </button>
                                </div>
                                {testMsg && (
                                    <p className={`text-xs mt-2 font-medium flex items-center gap-1 ${testStatus === 'success' ? 'text-emerald-600' : testStatus === 'error' ? 'text-red-600' : 'text-slate-500'}`}>
                                        {testStatus === 'success' && <Icons.CheckCircle size={12}/>}
                                        {testStatus === 'error' && <Icons.XCircle size={12}/>}
                                        {testMsg}
                                    </p>
                                )}
                                <p className="text-xs text-slate-400 mt-2">Key is stored locally in your browser (BYOK).</p>
                            </div>
                        </div>
                    )}
                    {activeTab === 'prompt' && (
                        <div className="space-y-4 h-full flex flex-col">
                            <div className="bg-blue-50 p-4 rounded-lg border border-blue-100 mb-2">
                                <h4 className="text-xs font-bold text-blue-700 uppercase mb-1">Variables</h4>
                                <p className="text-xs text-slate-600">Use <code className="bg-white px-1 rounded border border-blue-200">{`{{HORIZON}}`}</code> for years and <code className="bg-white px-1 rounded border border-blue-200">{`{{TEXT}}`}</code> for the document text.</p>
                            </div>
                            <div className="flex-1">
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-2">System Instruction</label>
                                <textarea value={localPrompt} onChange={(e) => setLocalPrompt(e.target.value)} className="w-full h-64 p-4 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none font-mono text-xs leading-relaxed resize-none" />
                            </div>
                            <button onClick={() => setLocalPrompt(DEFAULT_SYSTEM_PROMPT)} className="text-xs text-blue-600 font-bold hover:underline self-start">Reset to Default Prompt</button>
                        </div>
                    )}
                </div>
                <div className="p-4 border-t border-slate-100 bg-slate-50 flex justify-end gap-3 shrink-0">
                    <button onClick={onClose} className="px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-200 rounded-lg">Cancel</button>
                    <button onClick={handleSave} className="px-6 py-2 text-sm font-bold text-white bg-blue-600 hover:bg-blue-700 rounded-lg shadow-sm">Save Configuration</button>
                </div>
            </div>
        </div>
    );
};

// --- Methodology Guide ---
const MethodologyGuide = () => (
    <div className="mb-8 p-6 bg-white rounded-2xl border border-slate-100 shadow-sm text-center max-w-2xl mx-auto">
        <h3 className="text-sm font-bold text-blue-900 uppercase tracking-widest mb-3 flex items-center justify-center gap-2">
            <Icons.Globe size={16} className="text-blue-500"/> Methodology: The Futures Cone
        </h3>
        <p className="text-slate-600 text-sm mb-5 leading-relaxed">
            Uncertainty expands over time. This tool uses AI to map your project against four distinct zones of probability, helping you stress-test assumptions and identify blind spots.
        </p>
        <div className="grid grid-cols-4 gap-3 text-xs">
            <div className="bg-blue-50 p-3 rounded-lg border border-blue-100">
                <div className="font-bold text-blue-700 mb-1">Probable</div>
                <div className="text-blue-600/70 text-[10px] leading-tight">Business as usual. The baseline path.</div>
            </div>
            <div className="bg-emerald-50 p-3 rounded-lg border border-emerald-100">
                <div className="font-bold text-emerald-700 mb-1">Plausible</div>
                <div className="text-emerald-600/70 text-[10px] leading-tight">Credible alternatives if trends shift.</div>
            </div>
            <div className="bg-purple-50 p-3 rounded-lg border border-purple-100">
                <div className="font-bold text-purple-700 mb-1">Possible</div>
                <div className="text-purple-600/70 text-[10px] leading-tight">Radical shifts requiring new knowledge.</div>
            </div>
            <div className="bg-amber-50 p-3 rounded-lg border border-amber-100">
                <div className="font-bold text-amber-700 mb-1">Wildcard</div>
                <div className="text-amber-600/70 text-[10px] leading-tight">Low probability, high impact shocks.</div>
            </div>
        </div>
    </div>
);

// --- App Component ---
const App = () => {
    const [apiKey, setApiKey] = useState("");
    const [systemPrompt, setSystemPrompt] = useState(DEFAULT_SYSTEM_PROMPT);
    const [showSettings, setShowSettings] = useState(false);
    
    const [step, setStep] = useState('upload'); 
    const [logs, setLogs] = useState([]);
    const [text, setText] = useState("");
    const [fileName, setFileName] = useState("");
    const [result, setResult] = useState(null);
    const [activeZone, setActiveZone] = useState('probable');
    const [timeHorizon, setTimeHorizon] = useState(10);
    const [isDragging, setIsDragging] = useState(false);
    const [fileProcessing, setFileProcessing] = useState(false);
    const [errorMsg, setErrorMsg] = useState("");

    useEffect(() => {
        const storedKey = localStorage.getItem('gemini_api_key');
        const storedPrompt = localStorage.getItem('wb_foresight_prompt');
        if (storedKey) setApiKey(storedKey);
        if (storedPrompt) setSystemPrompt(storedPrompt);
    }, []);

    const handleFileDrop = async (e) => {
        e.preventDefault(); setIsDragging(false);
        const file = e.dataTransfer.files[0];
        if (file) await processFile(file);
    };

    const handleFileSelect = async (e) => {
        const file = e.target.files[0];
        if (file) await processFile(file);
    };

    const processFile = async (file) => {
        setFileProcessing(true); setFileName(file.name);
        try {
            const extractedText = await extractTextFromFile(file);
            extractedText?.trim() ? setText(extractedText) : (alert("Empty file"), setFileName(""));
        } catch (err) { alert(err); setFileName(""); }
        setFileProcessing(false);
    };

    const startAnalysis = async () => {
        if (!apiKey) {
            alert("Please enter a valid API Key in Settings before starting.");
            setShowSettings(true);
            return;
        }
        if (!text) return;
        
        setStep('analyzing');
        setErrorMsg("");
        setLogs([`Initializing Foresight Engine...`, `Horizon: ${timeHorizon} years...`, `Deep scanning document...`]);

        try {
            const analysis = await generateDeepInsights(text, apiKey, timeHorizon, systemPrompt);
            setResult(analysis);
            setStep('result');
        } catch (err) { 
            setErrorMsg(err.message);
            setLogs(prev => [...prev, `❌ Error: ${err.message}`]);
        }
    };

    const downloadPDF = () => {
        const element = document.getElementById('report-template');
        if(!element) return;
        const opt = {
            margin: 10,
            filename: `Foresight_Report_${result.sector}_${timeHorizon}y.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        html2pdf().set(opt).from(element).save();
    };

    return (
        <div className="min-h-screen flex flex-col bg-slate-50 text-slate-900 font-sans selection:bg-blue-100 selection:text-blue-900">
            {/* Nav */}
            <nav className="h-16 bg-white/80 backdrop-blur-md border-b border-slate-200 flex items-center justify-between px-8 sticky top-0 z-50">
                <div className="flex items-center gap-3">
                    <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-serif font-bold text-lg shadow-sm">W</div>
                    <div>
                        <h1 className="font-bold text-sm tracking-tight text-slate-900 display-font">Deep Foresight Engine</h1>
                        <span className="text-[10px] text-slate-500 uppercase tracking-widest block">Innovation Labs</span>
                    </div>
                </div>
                <div className="flex items-center gap-2">
                    {step === 'result' && (
                        <div className="flex gap-2">
                            <button 
                                onClick={downloadPDF}
                                className="text-xs font-bold text-blue-600 hover:text-blue-800 flex items-center gap-2 px-4 py-2 rounded-full border border-blue-100 hover:bg-blue-50 transition-colors mr-2 shadow-sm"
                            >
                                <Icons.Download size={14}/> Download Report
                            </button>
                            <button 
                                onClick={() => { setStep('upload'); setText(""); setFileName(""); }}
                                className="text-xs font-bold text-slate-500 hover:text-slate-700 flex items-center gap-2 px-4 py-2 rounded-full hover:bg-slate-50 transition-colors"
                            >
                                New Analysis <Icons.Search size={14}/>
                            </button>
                        </div>
                    )}
                    <button 
                        onClick={() => setShowSettings(true)}
                        className="p-2 rounded-full transition-colors text-blue-400 hover:text-blue-600 hover:bg-blue-50"
                        title="Configuration"
                    >
                        <Icons.Settings size={20}/>
                    </button>
                </div>
            </nav>

            <main className="flex-1 overflow-hidden relative flex">
                {step === 'upload' && (
                    <div className="w-full flex items-center justify-center p-6 animate-fade-in">
                        <div className="w-full max-w-2xl">
                            <h2 className="display-font text-4xl font-bold text-slate-900 mb-8 text-center">The Futures Cone</h2>
                            
                            <MethodologyGuide />

                            <TimelineSelector value={timeHorizon} onChange={setTimeHorizon} />

                            <p className="text-slate-500 text-center text-sm font-medium mb-4 max-w-md mx-auto">Upload your PID, PAD, or Concept Note to generate deep strategic scenarios.</p>

                            <div className="bg-white rounded-3xl shadow-xl shadow-slate-200/50 border border-slate-100 overflow-hidden">
                                <div 
                                    className={`p-12 border-b border-dashed border-slate-100 transition-all duration-300 relative text-center
                                        ${isDragging ? 'bg-blue-50/50' : 'bg-white'}`}
                                    onDragOver={(e) => { e.preventDefault(); setIsDragging(true); }}
                                    onDragLeave={() => setIsDragging(false)}
                                    onDrop={handleFileDrop}
                                >
                                    <input type="file" className="absolute inset-0 opacity-0 cursor-pointer z-10" onChange={handleFileSelect} accept=".pdf,.docx,.txt,.md" />
                                    
                                    {fileName ? (
                                        <div className="animate-fade-in">
                                            <div className="w-16 h-16 bg-emerald-50 text-emerald-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                                <Icons.FileText size={32}/>
                                            </div>
                                            <p className="font-bold text-slate-800 text-lg truncate max-w-xs mx-auto">{fileName}</p>
                                            <p className="text-xs text-emerald-600 font-bold uppercase tracking-wider mt-2">Ready for Analysis</p>
                                        </div>
                                    ) : (
                                        <div className="group">
                                            <div className="w-16 h-16 bg-slate-50 text-slate-400 rounded-2xl flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform group-hover:text-blue-500 group-hover:bg-blue-50">
                                                <Icons.Upload size={28} />
                                            </div>
                                            <p className="font-bold text-slate-700 text-lg">Drop Document Here</p>
                                            <p className="text-sm text-slate-400 mt-2">PDF, DOCX, TXT</p>
                                        </div>
                                    )}
                                </div>
                                <div className="p-2 bg-slate-50">
                                    <button 
                                        onClick={startAnalysis}
                                        disabled={!text}
                                        className={`w-full py-4 rounded-2xl font-bold text-white shadow-lg transition-all transform active:scale-[0.99] flex items-center justify-center gap-3 text-md
                                            ${!text ? 'bg-slate-300 shadow-none cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 shadow-blue-500/20'}`}
                                    >
                                        <Icons.Zap size={20} className={text ? "animate-pulse" : ""}/>
                                        Initiate Deep Research
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                )}

                {step === 'analyzing' && (
                    <div className="w-full flex flex-col items-center justify-center animate-fade-in gap-8">
                        {errorMsg ? (
                            <div className="bg-red-50 p-6 rounded-xl border border-red-100 max-w-md text-center shadow-lg">
                                <div className="text-red-500 mx-auto w-12 h-12 mb-4 flex items-center justify-center bg-red-100 rounded-full"><Icons.XCircle size={24}/></div>
                                <h3 className="font-bold text-red-900 mb-2">Analysis Failed</h3>
                                <p className="text-sm text-red-700 mb-6">{errorMsg}</p>
                                <div className="flex flex-col gap-3">
                                    <button 
                                        onClick={() => setShowSettings(true)} 
                                        className="bg-white border border-red-200 text-red-700 px-4 py-2 rounded-lg text-sm font-bold hover:bg-red-50 flex items-center justify-center gap-2"
                                    >
                                        <Icons.Settings size={16}/> Check API Settings
                                    </button>
                                    <button 
                                        onClick={() => setStep('upload')} 
                                        className="text-slate-500 hover:text-slate-700 text-sm font-medium underline"
                                    >
                                        Cancel and return
                                    </button>
                                </div>
                            </div>
                        ) : (
                            <>
                                <div className="relative w-20 h-20">
                                    <div className="absolute inset-0 border-4 border-slate-100 rounded-full"></div>
                                    <div className="absolute inset-0 border-4 border-blue-600 rounded-full border-t-transparent animate-spin"></div>
                                </div>
                                <div className="flex flex-col gap-2 items-center">
                                    {logs.map((log, i) => (
                                        <p key={i} className={`font-mono text-xs ${i === logs.length - 1 ? 'text-blue-600 font-bold' : 'text-slate-300'}`}>
                                            {log}
                                        </p>
                                    ))}
                                </div>
                            </>
                        )}
                    </div>
                )}

                {step === 'result' && result && (
                    <div className="w-full h-full flex animate-fade-in">
                        {/* LEFT: VISUALIZATION (40%) */}
                        <div className="w-[40%] bg-white relative flex flex-col border-r border-slate-100 shadow-[4px_0_24px_-12px_rgba(0,0,0,0.1)] z-10">
                             {/* Cone Container */}
                            <div className="flex-1 w-full h-full p-4 relative flex items-center justify-center bg-slate-50/30">
                                <div className="absolute top-6 left-6 z-20">
                                    <span className="text-[10px] font-bold bg-slate-100 text-slate-500 px-2 py-1 rounded uppercase tracking-wider">{result.sector}</span>
                                </div>
                                <div className="absolute top-6 right-6 z-20 pointer-events-none bg-blue-50 text-blue-600 text-[10px] font-bold px-3 py-1.5 rounded-full shadow-sm border border-blue-100 flex items-center gap-1 animate-bounce">
                                    <Icons.MousePointer size={12}/> Interactive
                                </div>
                                <ConeVisualization 
                                    width={500} 
                                    height={500} 
                                    activeZone={activeZone} 
                                    onZoneClick={setActiveZone}
                                    timeHorizon={timeHorizon}
                                />
                            </div>
                        </div>

                        {/* RIGHT: INSIGHTS (60%) */}
                        <div className="flex-1 bg-slate-50/50 flex flex-col h-full overflow-hidden">
                            <div className="h-full overflow-y-auto p-12 custom-scrollbar">
                                <div className="max-w-3xl mx-auto">
                                    {/* Header */}
                                    <div className="mb-8 border-b border-slate-200 pb-8">
                                        <div className={`inline-flex items-center gap-2 px-3 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-widest text-white mb-4 shadow-sm
                                            ${activeZone === 'wildcard' ? 'bg-amber-500' : 
                                              activeZone === 'possible' ? 'bg-purple-500' :
                                              activeZone === 'plausible' ? 'bg-emerald-500' : 'bg-blue-500'}`}>
                                            {activeZone} Future
                                        </div>
                                        <h2 className="serif-font text-4xl text-slate-900 leading-tight mb-2">
                                            {activeZone === 'wildcard' ? "Black Swan Event" : 
                                             activeZone === 'probable' ? "The Baseline Path" :
                                             activeZone === 'plausible' ? "Systemic Shift" : "Radical Transformation"}
                                        </h2>
                                        <p className="text-slate-500 text-sm">Strategic implications for {timeHorizon}-year horizon.</p>
                                    </div>

                                    {/* Main Content */}
                                    <div className="prose prose-slate max-w-none">
                                        <div className="bg-white p-8 rounded-2xl shadow-sm border border-slate-200/60 mb-8 relative overflow-hidden">
                                             <div className={`absolute left-0 top-0 bottom-0 w-1 ${activeZone === 'wildcard' ? 'bg-amber-500' : 
                                              activeZone === 'possible' ? 'bg-purple-500' :
                                              activeZone === 'plausible' ? 'bg-emerald-500' : 'bg-blue-500'}`}></div>
                                            <h3 className="display-font text-lg font-bold text-slate-900 mb-4 flex items-center gap-2">
                                                <Icons.Brain size={20} className="text-slate-400"/> Deep Insight
                                            </h3>
                                            <p className="text-slate-700 text-lg leading-relaxed">{result[activeZone]}</p>
                                        </div>

                                        <div className="grid grid-cols-2 gap-6">
                                            <div className="bg-orange-50/50 p-6 rounded-2xl border border-orange-100/60 hover:border-orange-200 transition-colors">
                                                <h4 className="flex items-center gap-2 text-orange-700 font-bold text-xs uppercase tracking-wider mb-3">
                                                    <Icons.Alert size={14}/> Hidden Risk
                                                </h4>
                                                <p className="text-slate-700 text-sm leading-relaxed">{result.risk}</p>
                                            </div>

                                            <div className="bg-blue-50/50 p-6 rounded-2xl border border-blue-100/60 hover:border-blue-200 transition-colors">
                                                <h4 className="flex items-center gap-2 text-blue-700 font-bold text-xs uppercase tracking-wider mb-3">
                                                    <Icons.Zap size={14}/> Strategic Action
                                                </h4>
                                                <p className="text-slate-700 text-sm leading-relaxed">{result.recommendation}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                )}

                <SettingsModal 
                    isOpen={showSettings} 
                    onClose={() => setShowSettings(false)} 
                    apiKey={apiKey} 
                    setApiKey={setApiKey} 
                    systemPrompt={systemPrompt}
                    setSystemPrompt={setSystemPrompt}
                />

                {/* Hidden Report Container for PDF Generation */}
                <div id="report-container">
                    {result && <ReportTemplate data={result} timeHorizon={timeHorizon} />}
                </div>
            </main>
        </div>
    );
};

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);

</script>
</body>
</html>
